#!/usr/bin/env bash
set -euo pipefail

echo "🔧 Setting up Rails Image Optimizer Demo…"

# Ensure we're in repo root
cd "$(dirname "$0")/.."

# 1) Ruby deps
if ! command -v bundle >/dev/null 2>&1; then
  echo "📦 Installing bundler…"
  gem install bundler -N
fi

echo "📦 bundle install…"
bundle install

# 2) System binaries (best-effort)
install_with_brew() {
  brew install pngcrush advancecomp optipng pngquant oxipng \
               jpegoptim jpeg-turbo jhead gifsicle imagemagick || true
}

install_with_apt() {
  sudo apt-get update -y
  sudo apt-get install -y pngcrush advancecomp optipng pngquant oxipng \
                          jpegoptim libjpeg-turbo-progs jhead gifsicle \
                          imagemagick || true
}

if command -v brew >/dev/null 2>&1; then
  echo "🍺 Homebrew detected — installing optimizers…"
  install_with_brew
elif command -v apt-get >/dev/null 2>&1; then
  echo "🐧 apt-get detected — installing optimizers…"
  install_with_apt
else
  echo "ℹ️ No supported package manager found; proceeding with available tools."
fi

# 3) Local svgo (no global npm needed later)
if command -v node >/dev/null 2>&1 && command -v npm >/dev/null 2>&1; then
  if [ ! -f package.json ]; then
    npm init -y >/dev/null 2>&1 || true
  fi
  npm pkg set scripts.svgo="svgo --help" >/dev/null 2>&1 || true
  npm i svgo --save-dev >/dev/null 2>&1 || true
  echo "🌀 svgo installed locally at ./node_modules/.bin/svgo"
else
  echo "ℹ️ Node/npm not found; SVG optimization will be auto-disabled."
fi

echo "✅ Setup complete."